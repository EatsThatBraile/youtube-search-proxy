<script>
  const qEl = document.getElementById('query');
  const btn = document.getElementById('search');
  const results = document.getElementById('results');

  // --- Safe duration parser ---
  function parseDuration(iso) {
    try {
      if (!iso || typeof iso !== "string") return "";
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!m) return "";
      const h = parseInt(m[1] || 0);
      const min = parseInt(m[2] || 0);
      const s = parseInt(m[3] || 0);
      const mm = (h * 60 + min).toString().padStart(2, "0");
      const ss = s.toString().padStart(2, "0");
      return (h ? h + ":" : "") + mm + ":" + ss;
    } catch (e) {
      console.warn("Bad duration value:", iso);
      return "";
    }
  }

  btn.onclick = async () => {
    const q = qEl.value.trim();
    if (!q) return;
    results.innerHTML = 'Loading...';
    try {
      const res = await fetch(`/api/search?query=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      results.innerHTML = '';
      if (!Array.isArray(data.items)) {
        results.innerHTML = '<div>No results found.</div>';
        return;
      }

      data.items.forEach(it => {
        if (!it.id || !it.id.videoId) return;
        const id = it.id.videoId;
        const s = it.snippet || {};
        const meta = (data.meta && data.meta[id]) || {};
        const dur = parseDuration(meta.duration);
        const view = meta.viewCount ? Number(meta.viewCount).toLocaleString() : "–";

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${s.thumbnails?.medium?.url || ''}" width="160" />
          <div>
            <div><b>${s.title || '(Untitled video)'}</b></div>
            <div>${s.channelTitle || ''}</div>
            <div>${dur || ''} ${view !== "–" ? ` • ${view} views` : ''}</div>
            <a target="_blank" href="https://www.youtube.com/watch?v=${id}">Watch</a>
          </div>
        `;
        results.appendChild(card);
      });
    } catch (err) {
      results.innerHTML = `<div style="color:red">${err.message}</div>`;
    }
  };
</script>
