<script>
  const qEl = document.getElementById('query');
  const btn = document.getElementById('search');
  const results = document.getElementById('results');

  function parseDuration(iso) {
    if (!iso || typeof iso !== "string") return "";
    const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    if (!m) return "";
    const h = parseInt(m[1] || 0);
    const min = parseInt(m[2] || 0);
    const s = parseInt(m[3] || 0);
    const mm = (h * 60 + min).toString().padStart(2, "0");
    const ss = s.toString().padStart(2, "0");
    return (h ? h + ":" : "") + mm + ":" + ss;
  }

  btn.addEventListener("click", searchVideos);
  qEl.addEventListener("keydown", e => {
    if (e.key === "Enter") searchVideos();
  });

  async function searchVideos() {
    const q = qEl.value.trim();
    if (!q) return;
    results.innerHTML = '<p>Loading...</p>';
    try {
      const res = await fetch(`/api/search?query=${encodeURIComponent(q)}`);
      const data = await res.json();

      if (!data || !Array.isArray(data.items)) {
        results.innerHTML = '<p style="color:red">No results found.</p>';
        return;
      }

      results.innerHTML = "";
      data.items.forEach(it => {
        if (!it.id || !it.id.videoId) return;
        const id = it.id.videoId;
        const s = it.snippet || {};
        const meta = (data.meta && data.meta[id]) || {};

        const dur = parseDuration(meta.duration || "");
        const view = meta.viewCount ? Number(meta.viewCount).toLocaleString() : "–";
        const thumb = s.thumbnails && s.thumbnails.medium ? s.thumbnails.medium.url : "";
        const title = s.title || "Untitled video";
        const channel = s.channelTitle || "Unknown channel";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${thumb}" width="160" height="90" alt="">
          <div>
            <div><b>${title}</b></div>
            <div>${channel}</div>
            <div>${dur ? dur + " • " : ""}${view !== "–" ? view + " views" : ""}</div>
            <a target="_blank" href="https://www.youtube.com/watch?v=${id}">Watch</a>
          </div>
        `;
        results.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      results.innerHTML = `<p style="color:red">${err.message}</p>`;
    }
  }
</script>
